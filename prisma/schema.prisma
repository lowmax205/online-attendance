generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Attendance {
  id                                 String             @id
  eventId                            String
  userId                             String
  verificationStatus                 VerificationStatus @default(Pending)
  verifiedById                       String?
  verifiedAt                         DateTime?
  disputeNote                        String?
  checkInBackPhoto                   String?
  checkInDistance                    Float?
  checkInFrontPhoto                  String?
  checkInIpAddress                   String?
  checkInLatitude                    Float?
  checkInLongitude                   Float?
  checkInSignature                   String?
  checkInSubmittedAt                 DateTime?
  checkInUserAgent                   String?
  checkOutBackPhoto                  String?
  checkOutDistance                   Float?
  checkOutFrontPhoto                 String?
  checkOutIpAddress                  String?
  checkOutLatitude                   Float?
  checkOutLongitude                  Float?
  checkOutSignature                  String?
  checkOutSubmittedAt                DateTime?
  checkOutUserAgent                  String?
  createdAt                          DateTime           @default(now())
  updatedAt                          DateTime           @default(now())
  appealMessage                      String?
  resolutionNotes                    String?
  Event                              Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  User_Attendance_userIdToUser       User               @relation("Attendance_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)
  User_Attendance_verifiedByIdToUser User?              @relation("Attendance_verifiedByIdToUser", fields: [verifiedById], references: [id])

  @@unique([eventId, userId])
  @@index([checkInSubmittedAt])
  @@index([eventId, verificationStatus])
  @@index([userId, checkInSubmittedAt])
  @@index([verificationStatus])
  @@index([verifiedById, verifiedAt])
}

model Event {
  id                           String       @id
  name                         String
  description                  String?
  startDateTime                DateTime
  endDateTime                  DateTime
  venueLatitude                Float
  venueLongitude               Float
  venueName                    String
  venueAddress                 String?
  campus                       Campus       @default(MainCampus)
  checkInBufferMins            Int          @default(30)
  checkOutBufferMins           Int          @default(30)
  qrCodeUrl                    String?
  qrCodePayload                String       @unique
  shortUrl                     String?
  eventCode                    String       @unique
  status                       EventStatus  @default(Active)
  createdById                  String
  createdAt                    DateTime     @default(now())
  updatedAt                    DateTime
  deletedAt                    DateTime?
  deletedById                  String?
  editHistory                  Json?
  hasAttendances               Boolean      @default(false)
  Attendance                   Attendance[]
  User_Event_createdByIdToUser User         @relation("Event_createdByIdToUser", fields: [createdById], references: [id])
  User_Event_deletedByIdToUser User?        @relation("Event_deletedByIdToUser", fields: [deletedById], references: [id])

  @@index([createdById])
  @@index([deletedAt])
  @@index([startDateTime, endDateTime])
  @@index([status])
  @@index([status, startDateTime])
  @@index([campus])
  @@index([eventCode])
}

model ExportRecord {
  id           String       @id
  createdAt    DateTime     @default(now())
  exportedById String
  format       ExportFormat
  filters      Json
  recordCount  Int
  status       ExportStatus @default(PENDING)
  errorMessage String?
  fileSize     Int?
  downloadUrl  String?
  expiresAt    DateTime?
  User         User         @relation(fields: [exportedById], references: [id])

  @@index([createdAt])
  @@index([exportedById, createdAt])
  @@index([status])
}

model SecurityLog {
  id        String            @id
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime          @default(now())
  metadata  Json?
  eventType SecurityEventType @default(LOGIN)
  success   Boolean           @default(true)
  User      User?             @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([eventType, createdAt])
  @@index([userId, createdAt])
}

model Session {
  id           String   @id
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([refreshToken])
  @@index([userId])
}

model SystemConfig {
  id                        String   @id
  defaultGpsRadiusMeters    Int      @default(100)
  defaultCheckInBufferMins  Int      @default(30)
  defaultCheckOutBufferMins Int      @default(30)
  updatedAt                 DateTime
  updatedById               String
  User                      User     @relation(fields: [updatedById], references: [id])
}

model User {
  id                                       String         @id
  email                                    String         @unique
  passwordHash                             String
  role                                     Role           @default(Student)
  emailVerified                            Boolean        @default(false)
  createdAt                                DateTime       @default(now())
  lastLoginAt                              DateTime?
  firstName                                String
  lastName                                 String
  deletedAt                                DateTime?
  deletedById                              String?
  passwordResetAt                          DateTime?
  passwordResetById                        String?
  suspendedAt                              DateTime?
  suspendedById                            String?
  accountStatus                            AccountStatus  @default(ACTIVE)
  statusChangeReason                       String?
  temporaryPassword                        String?
  temporaryPasswordUsageCount              Int            @default(0)
  temporaryPasswordCreatedAt               DateTime?
  Attendance_Attendance_userIdToUser       Attendance[]   @relation("Attendance_userIdToUser")
  Attendance_Attendance_verifiedByIdToUser Attendance[]   @relation("Attendance_verifiedByIdToUser")
  Event_Event_createdByIdToUser            Event[]        @relation("Event_createdByIdToUser")
  Event_Event_deletedByIdToUser            Event[]        @relation("Event_deletedByIdToUser")
  ExportRecord                             ExportRecord[]
  SecurityLog                              SecurityLog[]
  Session                                  Session[]
  SystemConfig                             SystemConfig[]
  User_User_deletedByIdToUser              User?          @relation("User_deletedByIdToUser", fields: [deletedById], references: [id])
  other_User_User_deletedByIdToUser        User[]         @relation("User_deletedByIdToUser")
  User_User_passwordResetByIdToUser        User?          @relation("User_passwordResetByIdToUser", fields: [passwordResetById], references: [id])
  other_User_User_passwordResetByIdToUser  User[]         @relation("User_passwordResetByIdToUser")
  User_User_suspendedByIdToUser            User?          @relation("User_suspendedByIdToUser", fields: [suspendedById], references: [id])
  other_User_User_suspendedByIdToUser      User[]         @relation("User_suspendedByIdToUser")
  UserProfile                              UserProfile?

  @@index([accountStatus])
  @@index([deletedAt])
  @@index([email])
  @@index([role])
  @@index([suspendedById])
}

model UserProfile {
  id                String     @id
  userId            String     @unique
  section           String?
  department        Department @default(CCIS)
  course            String     @default("")
  campus            Campus     @default(MainCampus)
  updatedAt         DateTime
  contactNumber     String?
  createdAt         DateTime   @default(now())
  studentId         String     @unique
  yearLevel         Int
  documentUrls      String[]   @default([])
  profilePictureUrl String?
  User              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
}

enum EventStatus {
  Active
  Completed
  Cancelled
}

enum ExportFormat {
  CSV
  XLSX
  PDF
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Role {
  Student
  Moderator
  Administrator
}

enum SecurityEventType {
  REGISTRATION
  LOGIN
  LOGOUT
  FAILED_LOGIN
  PASSWORD_CHANGE
  USER_ROLE_CHANGED
  USER_STATUS_CHANGED
  USER_EMAIL_CHANGED
  USER_CREATED
  USER_PASSWORD_RESET
  USER_DELETED
  EVENT_CREATED
  EVENT_EDITED
  EVENT_DELETED
  ATTENDANCE_VERIFIED
  ATTENDANCE_REJECTED
  ATTENDANCE_APPEALED
  DISPUTE_RESOLVED
  DATA_EXPORTED
  ANALYTICS_ACCESSED
}

enum VerificationStatus {
  Pending
  Approved
  Rejected
}

enum Department {
  CCIS
  COE
  CAS
  CAAS
  CTE
  COT
}

enum Campus {
  MainCampus
  MalimonoCampus
  MainitCampus
  ClaverCampus
  DelCarmenCampus
}
